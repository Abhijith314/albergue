<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="stdash.css">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

</head>

<body>
    <div class="top-navbar">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        <img src="logo albi.png" alt="Logo" class="logoimg">
        <span>Hostel Dashboard</span>
        <button class="btn-secondary" onclick="logout()" style="margin: 0;">Logout</button>
    </div>

    <div class="sidebar" id="sidebar">
        <a onclick="loadContent('dashboard')">üè† Dashboard</a>
        <a onclick="loadContent('leave')">üìù Leave Pass</a>
        <a onclick="loadContent('complaints')">üì¢ Complaints</a>
        <a onclick="loadContent('attendance')">üìÖ Attendance</a>
        <a onclick="loadContent('profile')">üë§ Profile</a>
    </div>

    <div class="container" id="content"></div>

    <!-- QR Scanner Container -->
    <div class="qr-scanner-container" id="qrScannerContainer">
        <div class="scanner-header">
            <h2 style="color: white; margin-bottom: 5px;">Scan QR Code</h2>
            <p style="color: #e0e7ff; margin-top: 0;">Align the QR code within the frame</p>
        </div>
        <div id="scanner-preview">
            <video id="scanner-video" style="width: 100%; height: 100%;"></video>
            <div class="scanner-overlay">
                <div class="scanner-target"></div>
            </div>
        </div>
        <div class="scanner-actions">
            <button class="scanner-btn cancel" onclick="closeQrScanner()">Cancel</button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD4BvknExGN8_aWhuw7lT846Lk0gHGNMMg",
            authDomain: "albergue-1985.firebaseapp.com",
            projectId: "albergue-1985",
            storageBucket: "albergue-1985.appspot.com",
            messagingSenderId: "957761019612",
            appId: "1:957761019612:web:f879fffb4999d3beb9de19"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Profile data object
        let profileData = {
            name: "",
            regNumber: "",
            phone: "",
            address: "",
            fathersName: "",
            fathersPhone: "",
            mothersName: "",
            mothersPhone: "",
            course: "",
            semester: "",
            yearOfJoining: ""
        };

        // Current month's attendance data
        let currentMonthAttendance = [];
        let complaintsListener = null;
        let attendanceListener = null;
        let leavePassListener = null;

        // Load profile data from Firestore
        async function loadProfileData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.error("No user logged in");
                    return;
                }

                const doc = await db.collection("students").doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    profileData = {
                        name: data.name || "",
                        regNumber: data.regNumber || "",
                        phone: data.phone || "",
                        address: data.address || "",
                        fathersName: data.fathersName || "",
                        fathersPhone: data.fathersPhone || "",
                        mothersName: data.mothersName || "",
                        mothersPhone: data.mothersPhone || "",
                        course: data.course || "",
                        semester: data.semester || "",
                        yearOfJoining: data.yearOfJoining || ""
                    };
                    
                    console.log("Profile loaded:", profileData);
                    document.dispatchEvent(new Event('profileLoaded'));
                } else {
                    console.log("No profile data found");
                }
            } catch (error) {
                console.error("Error loading profile data:", error);
            }
        }

        // Load complaints from Firestore
        async function loadComplaints() {
            try {
                if (!profileData.regNumber) {
                    await loadProfileData();
                    if (!profileData.regNumber) {
                        throw new Error("Registration number missing");
                    }
                }

                console.log("Loading complaints for:", profileData.regNumber);
                const querySnapshot = await db.collection("complaints")
                    .where("studentId", "==", profileData.regNumber)
                    .orderBy("date", "desc")
                    .get();

                return querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        category: data.category || "General",
                        description: data.description || "",
                        status: data.status || "Pending",
                        formattedDate: data.date?.toDate().toLocaleDateString() || "N/A"
                    };
                });
            } catch (error) {
                console.error("Load complaints error:", error);
                throw error;
            }
        }

        // Set up real-time listener for complaints
        function setupComplaintsListener() {
            if (!profileData.regNumber) {
                console.error("No registration number for listener");
                return;
            }

            // Remove existing listener if any
            if (complaintsListener) {
                complaintsListener();
            }

            complaintsListener = db.collection("complaints")
                .where("studentId", "==", profileData.regNumber)
                .orderBy("date", "desc")
                .onSnapshot(snapshot => {
                    const updatedComplaints = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            category: data.category || "General",
                            description: data.description || "",
                            status: data.status || "Pending",
                            formattedDate: data.date?.toDate().toLocaleDateString() || "N/A"
                        };
                    });
                    updateComplaintsTable(updatedComplaints);
                }, error => {
                    console.error("Listener error:", error);
                    showComplaintsError(error);
                });
        }

        // Update complaints table with data
        function updateComplaintsTable(complaints) {
            const tableBody = document.querySelector('#complaintsTable tbody');
            if (!tableBody) return;

            if (complaints.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">No complaints found</td></tr>';
                return;
            }

            tableBody.innerHTML = complaints.map(complaint => `
                <tr>
                    <td>${complaint.formattedDate}</td>
                    <td>${complaint.category}</td>
                    <td>${complaint.description}</td>
                    <td class="${complaint.status.toLowerCase()}">${complaint.status}</td>
                </tr>
            `).join('');
        }

        // Show error in complaints table
        function showComplaintsError(error) {
            const tableBody = document.querySelector('#complaintsTable tbody');
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="4" style="color:red">Error loading complaints: ${error.message}</td></tr>`;
            }
        }

        // Render complaints table
        async function renderComplaints() {
            const tableBody = document.querySelector('#complaintsTable tbody');
            if (!tableBody) return;

            try {
                tableBody.innerHTML = '<tr><td colspan="4">Loading complaints...</td>';
                
                if (!profileData.regNumber) {
                    await loadProfileData();
                }

                const complaints = await loadComplaints();
                updateComplaintsTable(complaints);
                setupComplaintsListener();
            } catch (error) {
                console.error("Render complaints error:", error);
                showComplaintsError(error);
            }
        }

        // Submit new complaint
        async function submitComplaint() {
    try {
        const category = document.getElementById('category').value;
        const description = document.getElementById('complaintDesc').value;
        
        if (!category || !description) {
            throw new Error("Please fill all fields");
        }

        if (!profileData.regNumber) {
            await loadProfileData();
            if (!profileData.regNumber) {
                throw new Error("Profile information not available");
            }
        }

        await db.collection("complaints").add({
            studentId: profileData.regNumber,
            studentName: profileData.name,
            category: category,
            description: description,
            date: firebase.firestore.FieldValue.serverTimestamp(),
            status: "Pending", // Capitalize to match admin dashboard
            priority: "Medium", // Add priority field
            room: profileData.room || "N/A" // Add room field
        });

        alert('Complaint submitted successfully!');
        hideComplaintForm();
    } catch (error) {
        console.error("Submit complaint error:", error);
        alert(error.message);
    }
}

        // Load leave passes from Firestore
        async function loadLeavePasses() {
            try {
                if (!profileData.regNumber) {
                    await loadProfileData();
                    if (!profileData.regNumber) {
                        throw new Error("Registration number missing");
                    }
                }

                console.log("Loading leave passes for:", profileData.regNumber);
                const querySnapshot = await db.collection("leavePasses")
                    .where("studentId", "==", profileData.regNumber)
                    .orderBy("fromDate", "desc")
                    .get();

                return querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    const fromDate = data.fromDate?.toDate();
                    const toDate = data.toDate?.toDate();
                    const requestDate = data.requestDate?.toDate();
                    
                    return {
                        id: doc.id,
                        fromDate: fromDate ? fromDate.toLocaleDateString() : "N/A",
                        toDate: toDate ? toDate.toLocaleDateString() : "N/A",
                        reason: data.reason || "",
                        status: data.status || "Pending",
                        requestDate: requestDate ? requestDate.toLocaleDateString() : "N/A"
                    };
                });
            } catch (error) {
                console.error("Load leave passes error:", error);
                throw error;
            }
        }

        // Set up real-time listener for leave passes
        function setupLeavePassListener() {
            if (!profileData.regNumber) {
                console.error("No registration number for listener");
                return;
            }

            // Remove existing listener if any
            if (leavePassListener) {
                leavePassListener();
            }

            leavePassListener = db.collection("leavePasses")
                .where("studentId", "==", profileData.regNumber)
                .orderBy("fromDate", "desc")
                .onSnapshot(snapshot => {
                    const updatedLeavePasses = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const fromDate = data.fromDate?.toDate();
                        const toDate = data.toDate?.toDate();
                        const requestDate = data.requestDate?.toDate();
                        
                        return {
                            id: doc.id,
                            fromDate: fromDate ? fromDate.toLocaleDateString() : "N/A",
                            toDate: toDate ? toDate.toLocaleDateString() : "N/A",
                            reason: data.reason || "",
                            status: data.status || "Pending",
                            requestDate: requestDate ? requestDate.toLocaleDateString() : "N/A"
                        };
                    });
                    updateLeavePassTable(updatedLeavePasses);
                }, error => {
                    console.error("Leave pass listener error:", error);
                    showLeavePassError(error);
                });
        }

        // Update leave pass table with data
        function updateLeavePassTable(leavePasses) {
            const tableBody = document.querySelector('#leavePassTable tbody');
            if (!tableBody) return;

            if (leavePasses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No leave passes found</td></tr>';
                return;
            }

            tableBody.innerHTML = leavePasses.map(pass => `
                <tr>
                    <td>${pass.requestDate}</td>
                    <td>${pass.fromDate}</td>
                    <td>${pass.toDate}</td>
                    <td>${pass.reason}</td>
                    <td class="${pass.status.toLowerCase()}">${pass.status}</td>
                    <td><a href="#" onclick="viewLeavePass('${pass.id}')" style="color: #1e3a8a;">View</a></td>
                </tr>
            `).join('');
        }

        // Show error in leave pass table
        function showLeavePassError(error) {
            const tableBody = document.querySelector('#leavePassTable tbody');
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="6" style="color:red">Error loading leave passes: ${error.message}</td></tr>`;
            }
        }

        // View leave pass details
        async function viewLeavePass(passId) {
            try {
                const doc = await db.collection("leavePasses").doc(passId).get();
                if (doc.exists) {
                    const data = doc.data();
                    const fromDate = data.fromDate?.toDate();
                    const toDate = data.toDate?.toDate();
                    const requestDate = data.requestDate?.toDate();
                    
                    alert(`Leave Pass Details:\n\n` +
                          `Request Date: ${requestDate ? requestDate.toLocaleDateString() : "N/A"}\n` +
                          `From: ${fromDate ? fromDate.toLocaleDateString() : "N/A"}\n` +
                          `To: ${toDate ? toDate.toLocaleDateString() : "N/A"}\n` +
                          `Reason: ${data.reason || "N/A"}\n` +
                          `Status: ${data.status || "Pending"}\n` +
                          `Approved By: ${data.approvedBy || "N/A"}\n` +
                          `Remarks: ${data.remarks || "N/A"}`);
                } else {
                    alert("Leave pass not found");
                }
            } catch (error) {
                console.error("Error viewing leave pass:", error);
                alert("Error loading leave pass details");
            }
        }

        // Render leave passes table
        async function renderLeavePasses() {
            const tableBody = document.querySelector('#leavePassTable tbody');
            if (!tableBody) return;

            try {
                tableBody.innerHTML = '<tr><td colspan="6">Loading leave passes...</td>';
                
                if (!profileData.regNumber) {
                    await loadProfileData();
                }

                const leavePasses = await loadLeavePasses();
                updateLeavePassTable(leavePasses);
                setupLeavePassListener();
            } catch (error) {
                console.error("Render leave passes error:", error);
                showLeavePassError(error);
            }
        }

        // Submit new leave request
        async function submitLeaveRequest() {
            try {
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                const reason = document.getElementById('reason').value;

                if (!fromDate || !toDate || !reason) {
                    alert('Please fill all fields');
                    return;
                }

                if (!profileData.regNumber) {
                    await loadProfileData();
                    if (!profileData.regNumber) {
                        throw new Error("Profile information not available");
                    }
                }

                // Convert dates to Firestore Timestamp
                const fromDateObj = new Date(fromDate);
                const toDateObj = new Date(toDate);

                await db.collection("leavePasses").add({
                    studentId: profileData.regNumber,
                    studentName: profileData.name,
                    fromDate: firebase.firestore.Timestamp.fromDate(fromDateObj),
                    toDate: firebase.firestore.Timestamp.fromDate(toDateObj),
                    reason: reason,
                    requestDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: "Pending"
                });

                alert('Leave request submitted successfully!');
                hideLeaveForm();
            } catch (error) {
                console.error("Submit leave request error:", error);
                alert(error.message);
            }
        }

        // Load attendance data from Firestore
        async function loadStudentAttendance() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.error("No user logged in");
                    return;
                }

                // Ensure profile data is loaded
                if (!profileData.regNumber) {
                    await loadProfileData();
                    if (!profileData.regNumber) {
                        console.error("Registration number not available");
                        return;
                    }
                }

                // Get current month's attendance
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                const querySnapshot = await db.collection("attendance")
                    .where("studentId", "==", profileData.regNumber)
                    .where("date", ">=", firstDay)
                    .where("date", "<=", lastDay)
                    .orderBy("date", "desc")
                    .get();
                
                const tableBody = document.querySelector('#attendanceTable tbody');
                tableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No attendance records found for this month</td></tr>';
                    updateSummaryStats([]);
                    return;
                }
                
                const attendanceRecords = [];
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.date.toDate();
                    const formattedDate = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    attendanceRecords.push({
                        date: formattedDate,
                        morningStatus: data.morningStatus || "Not recorded",
                        eveningStatus: data.eveningStatus || "Not recorded",
                        remarks: data.remarks || "-"
                    });
                });
                
                // Update attendance table
                updateAttendanceTable(attendanceRecords);
                
                // Update summary stats
                updateSummaryStats(attendanceRecords);
                
                // Set up real-time listener
                setupAttendanceListener();
                
            } catch (error) {
                console.error("Error loading attendance:", error);
                const tableBody = document.querySelector('#attendanceTable tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Error loading attendance</td></tr>';
                }
            }
        }

        // Set up real-time listener for attendance
        function setupAttendanceListener() {
            const user = auth.currentUser;
            if (!user || !profileData.regNumber) return;

            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            // Remove existing listener if any
            if (attendanceListener) {
                attendanceListener();
            }

            attendanceListener = db.collection("attendance")
                .where("studentId", "==", profileData.regNumber)
                .where("date", ">=", firstDay)
                .where("date", "<=", lastDay)
                .orderBy("date", "desc")
                .onSnapshot((snapshot) => {
                    const updatedRecords = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.date.toDate();
                        const formattedDate = date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        
                        updatedRecords.push({
                            date: formattedDate,
                            morningStatus: data.morningStatus || "Not recorded",
                            eveningStatus: data.eveningStatus || "Not recorded",
                            remarks: data.remarks || "-"
                        });
                    });
                    
                    updateAttendanceTable(updatedRecords);
                    updateSummaryStats(updatedRecords);
                }, (error) => {
                    console.error("Error listening to attendance:", error);
                    const tableBody = document.querySelector('#attendanceTable tbody');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Error loading attendance</td></tr>';
                    }
                });
        }

        // Update attendance table with data
        function updateAttendanceTable(records) {
            const tableBody = document.querySelector('#attendanceTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No attendance records found</td></tr>';
                return;
            }
            
            records.forEach(record => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td style="color: ${getStatusColor(record.morningStatus)}">${record.morningStatus}</td>
                    <td style="color: ${getStatusColor(record.eveningStatus)}">${record.eveningStatus}</td>
                    <td>${record.remarks}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Update attendance summary stats
        function updateSummaryStats(records) {
            if (records.length === 0) {
                document.getElementById('present-days').textContent = "0";
                document.getElementById('absent-days').textContent = "0";
                document.getElementById('attendance-rate').textContent = "0%";
                return;
            }
            
            let presentCount = 0;
            let absentCount = 0;
            
            records.forEach(record => {
                if (record.morningStatus === "Present" && record.eveningStatus === "Present") {
                    presentCount++;
                } else if (record.morningStatus === "Absent" || record.eveningStatus === "Absent") {
                    absentCount++;
                }
            });
            
            const totalDays = records.length;
            const attendanceRate = Math.round((presentCount / totalDays) * 100);
            
            document.getElementById('present-days').textContent = presentCount;
            document.getElementById('absent-days').textContent = absentCount;
            document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
        }

        // Get color for status
        function getStatusColor(status) {
            if (status === "Present") return "#10b981";
            if (status === "Absent") return "#ef4444";
            if (status === "Late") return "#f59e0b";
            return "#6b7280";
        }

        // Download attendance as CSV
        function downloadAttendance() {
            const month = document.getElementById('month').value;
            const monthNames = {
                'january': 'January 2025',
                'february': 'February 2025',
                'march': 'March 2025'
            };
            const monthName = monthNames[month];

            // Get the attendance data from the table
            const table = document.getElementById('attendanceTable');
            const rows = table.querySelectorAll('tbody tr');
            let csvContent = "data:text/csv;charset=utf-8,";

            // Add headers
            csvContent += "Date,Morning Status,Evening Status,Remarks\n";

            // Add rows
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const date = cells[0].textContent;
                const morningStatus = cells[1].textContent;
                const eveningStatus = cells[2].textContent;
                const remarks = cells[3].textContent;
                csvContent += `${date},${morningStatus},${eveningStatus},${remarks}\n`;
            });

            // Create a link element to trigger the download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `Attendance_Report_${monthName}.csv`);
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the DOM
            document.body.removeChild(link);

            alert(`Attendance report for ${monthName} downloaded successfully!`);
        }

        // QR Scanner functions
        function openQrScanner() {
            const scannerContainer = document.getElementById('qrScannerContainer');
            scannerContainer.style.display = 'flex';

            // Access the camera
            const video = document.getElementById('scanner-video');

            // Check if getUserMedia is supported
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(function (stream) {
                        video.srcObject = stream;
                        video.play();
                        // In a real implementation, we would start scanning for QR codes here
                        // using a library like jsQR or instascan
                    })
                    .catch(function (error) {
                        console.error("Camera error:", error);
                        alert("Could not access the camera. " + error.message);
                        closeQrScanner();
                    });
            } else {
                alert("Sorry, your browser doesn't support accessing the camera.");
                closeQrScanner();
            }
        }

        function closeQrScanner() {
            const scannerContainer = document.getElementById('qrScannerContainer');
            scannerContainer.style.display = 'none';

            // Stop the video stream if it exists
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // For demonstration purposes - this would be called when a valid leave pass QR is scanned
        function processLeavePassQr(passId) {
            // In a real app, this would fetch the pass details from the server
            alert(`Processing leave pass ID: ${passId}`);
            loadContent('leave');
        }

        // Save profile to Firestore
        async function saveProfile(event) {
            event.preventDefault();

            try {
                const user = auth.currentUser;
                if (!user) {
                    alert("No user logged in");
                    return;
                }

                // Update profile data object with form values
                const updatedProfile = {
                    name: document.getElementById('name').value,
                    regNumber: document.getElementById('regNumber').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    fathersName: document.getElementById('fathersName').value,
                    fathersPhone: document.getElementById('fathersPhone').value,
                    mothersName: document.getElementById('mothersName').value,
                    mothersPhone: document.getElementById('mothersPhone').value,
                    course: document.getElementById('course').value,
                    semester: document.getElementById('semester').value,
                    yearOfJoining: document.getElementById('yearOfJoining').value
                };

                // Update Firestore
                await db.collection("students").doc(user.uid).set(updatedProfile, { merge: true });

                // Update local profile data
                profileData = updatedProfile;

                // Show success message
                alert('Profile updated successfully!');

                // Redirect to dashboard to see updated profile
                loadContent('dashboard');
            } catch (error) {
                console.error("Error saving profile:", error);
                alert("Error updating profile. Please try again.");
            }
        }

        // Fill profile form with existing data
        function fillProfileForm() {
            // Only fill form if we're on the profile page
            if (document.getElementById('name')) {
                document.getElementById('name').value = profileData.name;
                document.getElementById('regNumber').value = profileData.regNumber;
                document.getElementById('phone').value = profileData.phone;
                document.getElementById('address').value = profileData.address;
                document.getElementById('fathersName').value = profileData.fathersName;
                document.getElementById('fathersPhone').value = profileData.fathersPhone;
                document.getElementById('mothersName').value = profileData.mothersName;
                document.getElementById('mothersPhone').value = profileData.mothersPhone;
                document.getElementById('course').value = profileData.course;
                document.getElementById('semester').value = profileData.semester;
                document.getElementById('yearOfJoining').value = profileData.yearOfJoining;
            }
        }

        // Show/hide complaint form
        function showNewComplaintForm() {
            document.getElementById('complaintForm').style.display = 'block';
        }

        function hideComplaintForm() {
            document.getElementById('complaintForm').style.display = 'none';
            document.getElementById('newComplaintForm').reset();
        }

        // Show/hide leave form
        function showNewLeaveForm() {
            document.getElementById('leaveForm').style.display = 'block';
        }

        function hideLeaveForm() {
            document.getElementById('leaveForm').style.display = 'none';
            document.getElementById('newLeaveForm').reset();
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = "albi.html";
            }).catch((error) => {
                console.error("Logout error:", error);
                alert("Error logging out. Please try again.");
            });
        }

        // Helper function to get initials from name
        function getInitials(name) {
            if (!name) return "?";
            return name
                .split(' ')
                .map(word => word.charAt(0))
                .join('')
                .toUpperCase();
        }

        // Helper function to get formatted semester text
        function getSemesterText(semester) {
            return semester ? `Semester ${semester}` : "Not specified";
        }

        // Toggle mobile menu
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Load content based on page
        function loadContent(page) {
            const content = document.getElementById('content');

            // Close mobile menu after selection
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }

            if (page === 'dashboard') {
                content.innerHTML = `
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">${getInitials(profileData.name)}</div>
                        <div>
                            <h1 style="margin: 0;">${profileData.name}</h1>
                            <p style="margin: 0;">${profileData.regNumber}</p>
                            <button class="edit-profile-btn" onclick="loadContent('profile')">‚úèÔ∏è Edit Profile</button>
                        </div>
                    </div>
                    <div class="profile-info">
                        <div class="profile-detail">
                            <h4>Course</h4>
                            <p>${profileData.course}</p>
                        </div>
                        <div class="profile-detail">
                            <h4>Semester</h4>
                            <p>${getSemesterText(profileData.semester)}</p>
                        </div>
                        <div class="profile-detail">
                            <h4>Phone</h4>
                            <p>${profileData.phone}</p>
                        </div>
                        <div class="profile-detail">
                            <h4>Parent Contact</h4>
                            <p>${profileData.fathersName}: ${profileData.fathersPhone}</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h1>Dashboard</h1>
                    <p>Welcome to the Hostel Management System. Use the sidebar to navigate to different features.</p>
                    <div class="stats-container">
                        <div class="stat-card" style="background-color: #e0e7ff;">
                            <h3 style="margin-top: 0; color: #1e3a8a;">Pending Complaints</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">1</p>
                        </div>
                        <div class="stat-card" style="background-color: #e0f2fe;">
                            <h3 style="margin-top: 0; color: #1e3a8a;">Leave Requests</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">2</p>
                        </div>
                        <div class="stat-card" style="background-color: #dcfce7;">
                            <h3 style="margin-top: 0; color: #1e3a8a;">Attendance Rate</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">96%</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h1>Recent Notifications</h1>
                    <ul style="padding-left: 20px;">
                        <li>Internet maintenance scheduled for Saturday (March 23, 2025)</li>
                        <li>Room inspection will be conducted next Monday</li>
                        <li>Your leave request for March 25-26 has been approved</li>
                    </ul>
                </div>`;
            } else if (page === 'leave') {
                content.innerHTML = `
                <div class="card">
                    <h1>Leave Pass Requests</h1>
                    <div class="table-responsive">
                        <table id="leavePassTable">
                            <thead>
                                <tr>
                                    <th>Request Date</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center;">Loading leave passes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-icon" onclick="openQrScanner()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <rect x="7" y="7" width="3" height="3"></rect>
                            <rect x="14" y="7" width="3" height="3"></rect>
                            <rect x="7" y="14" width="3" height="3"></rect>
                            <rect x="14" y="14" width="3" height="3"></rect>
                        </svg>
                        Scan QR Code
                    </button>
                    <div class="or-divider">
                        <span class="or-divider-text">OR</span>
                    </div>
                    <button class="btn" onclick="showNewLeaveForm()">Request New Leave</button>
                </div>
                <div id="leaveForm" style="display: none;" class="card">
                    <h1>New Leave Request</h1>
                    <form id="newLeaveForm">
                        <div class="form-group">
                            <label class="form-label" for="fromDate">From Date:</label>
                            <input type="date" id="fromDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="toDate">To Date:</label>
                            <input type="date" id="toDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="reason">Reason:</label>
                            <textarea id="reason" rows="4" class="form-input"></textarea>
                        </div>
                        <div class="form-action">
                            <button type="button" class="btn" onclick="submitLeaveRequest()">Submit Request</button>
                            <button type="button" class="btn-secondary" onclick="hideLeaveForm()">Cancel</button>
                        </div>
                    </form>
                </div>`;
                
                // Render leave passes after the HTML is loaded
                setTimeout(() => {
                    renderLeavePasses();
                }, 0);
            } else if (page === 'complaints') {
                content.innerHTML = `
                <div class="card">
                    <h1>Complaints</h1>
                    <div class="table-responsive">
                        <table id="complaintsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" style="text-align: center;">Loading complaints...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn" onclick="showNewComplaintForm()">Add New Complaint</button>
                </div>
                <div id="complaintForm" style="display: none;" class="card">
                    <h1>New Complaint</h1>
                    <form id="newComplaintForm">
                        <div class="form-group">
                            <label class="form-label" for="category">Category:</label>
                            <select id="category" class="form-input" required>
                                <option value="">Select a category</option>
                                <option value="Network">Network</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="complaintDesc">Description:</label>
                            <textarea id="complaintDesc" rows="4" class="form-input" required placeholder="Describe your complaint in detail..."></textarea>
                        </div>
                        <div class="form-action">
                            <button type="button" class="btn" onclick="submitComplaint()">Submit Complaint</button>
                            <button type="button" class="btn-secondary" onclick="hideComplaintForm()">Cancel</button>
                        </div>
                    </form>
                </div>`;
                
                // Render complaints after the HTML is loaded
                setTimeout(() => {
                    renderComplaints();
                }, 0);
            
            } else if (page === 'attendance') {
                content.innerHTML = `
                <div class="card">
                    <h1>Attendance Record</h1>
                    <div class="download-container">
                        <div>
                            <label for="month" style="margin-right: 10px;">Select Month:</label>
                            <select id="month" onchange="updateAttendance()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="march">March 2025</option>
                                <option value="february">February 2025</option>
                                <option value="january">January 2025</option>
                            </select>
                        </div>
                        <button class="btn" onclick="downloadAttendance()">Download Attendance</button>
                    </div>
                    <div class="table-responsive">
                        <table id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Morning</th>
                                    <th>Evening</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" style="text-align: center;">Loading attendance...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="summary-box">
                        <p style="margin: 0;"><strong>Attendance Summary (<span id="month-name">March</span> 2025):</strong></p>
                        <p style="margin: 10px 0 0 0;">Present: <span id="present-days">0</span> days | Absent: <span id="absent-days">0</span> day | Attendance Rate: <span id="attendance-rate">0%</span></p>
                    </div>
                </div>`;
                
                // Load attendance data when page loads
                loadStudentAttendance();

            } else if (page === 'profile') {
                content.innerHTML = `
                <div class="card profile-section">
                    <h1>Student Profile</h1>
                    <form id="studentProfileForm" onsubmit="saveProfile(event)">
                        <!-- Personal Information -->
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="name">Name</label>
                                    <input type="text" id="name" name="name" required>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="regNumber">Register Number</label>
                                    <input type="text" id="regNumber" name="regNumber" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" name="phone" required>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="address">Address</label>
                                    <textarea id="address" name="address" required></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Father's Details -->
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="fathersName">Father's Name</label>
                                    <input type="text" id="fathersName" name="fathersName" required>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="fathersPhone">Father's Phone Number</label>
                                    <input type="tel" id="fathersPhone" name="fathersPhone" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mother's Details -->
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="mothersName">Mother's Name</label>
                                    <input type="text" id="mothersName" name="mothersName" required>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="mothersPhone">Mother's Phone Number</label>
                                    <input type="tel" id="mothersPhone" name="mothersPhone" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Academic Information -->
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="course">Course</label>
                                    <input type="text" id="course" name="course" required>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="semester">Semester</label>
                                    <select id="semester" name="semester" required>
                                        <option value="">Select Semester</option>
                                        <option value="1">Semester 1</option>
                                        <option value="2">Semester 2</option>
                                        <option value="3">Semester 3</option>
                                        <option value="4">Semester 4</option>
                                        <option value="5">Semester 5</option>
                                        <option value="6">Semester 6</option>
                                        <option value="7">Semester 7</option>
                                        <option value="8">Semester 8</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="yearOfJoining">Year of Joining</label>
                            <input type="number" id="yearOfJoining" name="yearOfJoining" min="2000" max="2030" required>
                        </div>
                        
                        <div class="buttons">
                            <button type="submit" class="btn">Save Profile</button>
                        </div>
                    </form>
                </div>`;

                // Fill the form with existing data
                fillProfileForm();
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        await loadProfileData();
                        loadContent('dashboard');
                    } catch (error) {
                        console.error("Auth state error:", error);
                        window.location.href = "albi.html";
                    }
                } else {
                    window.location.href = "albi.html";
                }
            });
        });

        // Event listener for when profile is loaded
        document.addEventListener('profileLoaded', function() {
            fillProfileForm();
        });
    </script>
</body>
</html>