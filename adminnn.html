<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hostel Admin Dashboard</title>
    <link rel="stylesheet" href="adminnn.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
    
  
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
        
    
    
</head>

<body>

    <div class="top-navbar">
        <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
        <img src="https://via.placeholder.com/40" alt="Logo" style="filter: brightness(0) invert(1);">
        <span>Hostel Admin Dashboard</span>
        <button class="btn-secondary" onclick="logout()" style="margin-left: auto; margin-right: 10px;">Logout</button>
    </div>

    <div class="sidebar" id="sidebar">
        <a onclick="loadContent('dashboard')">üìä Dashboard</a>
        <a onclick="loadContent('registrations')">üìù Registrations</a>
        <a onclick="loadContent('leave')">üóìÔ∏è Leave Applications</a>
        <a onclick="loadContent('complaints')">üîß Complaints</a>
        <a onclick="loadContent('attendance')">üìã Attendance</a>
        <a onclick="loadContent('billing')">üí∞ Billing</a>
        <a onclick="loadContent('alerts')">üîî Alerts & Notifications</a>
    </div>

    <div class="container" id="content"></div>

    <script>
        
         // Initialize Firebase
         const firebaseConfig = {
            apiKey: "AIzaSyD4BvknExGN8_aWhuw7lT846Lk0gHGNMMg",
            authDomain: "albergue-1985.firebaseapp.com",
            projectId: "albergue-1985",
            storageBucket: "albergue-1985.appspot.com",
            messagingSenderId: "957761019612",
            appId: "1:957761019612:web:f879fffb4999d3beb9de19"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        
        // Load dashboard by default when page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadContent('dashboard');
        });

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
        }
  // Function to handle logout
function logout() {
    firebase.auth().signOut().then(() => {
        // Sign-out successful
        window.location.href = "login.html";
    }).catch((error) => {
        // An error happened
        console.error("Logout error:", error);
        alert("Error signing out: " + error.message);
    });
}async function loadComplaints(status) {
    try {
        const tableBody = document.querySelector('#complaintsTable tbody');
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Loading complaints...</td></tr>';
        
        // Convert status to proper case for Firestore query
        const formattedStatus = status === 'pending' ? 'Pending' : 
                              status === 'inProgress' ? 'InProgress' : 
                              status === 'resolved' ? 'Resolved' : status;
        
        const querySnapshot = await db.collection("complaints")
            .where("status", "==", formattedStatus)
            .orderBy("date", "desc")
            .get();
        
        if (querySnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No complaints found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        
        querySnapshot.forEach(doc => {
            const data = doc.data();
            const date = data.date.toDate();
            const formattedDate = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${doc.id}</td>
                <td>${data.studentName || 'N/A'}</td>
                <td>${data.room || 'N/A'}</td>
                <td>${data.category || 'N/A'}</td>
                <td>${data.description || 'N/A'}</td>
                <td>${formattedDate}</td>
                <td><span class="badge ${getPriorityBadgeClass(data.priority)}">${data.priority || 'Medium'}</span></td>
                <td><span class="badge ${getStatusBadgeClass(data.status)}">${data.status}</span></td>
                <td>
                    ${data.status === 'Resolved' ? 
                        `<button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>` :
                        `<button class="btn-success" onclick="resolveComplaint('${doc.id}')">Resolve</button>
                         <button class="btn-warning" onclick="assignComplaint('${doc.id}')">Assign</button>
                         <button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>`
                    }
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
    } catch (error) {
        console.error("Error loading complaints:", error);
        const tableBody = document.querySelector('#complaintsTable tbody');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Error loading complaints</td></tr>';
        }
    }
}
function setupComplaintsListener(status) {
    const formattedStatus = status === 'pending' ? 'Pending' : 
                          status === 'inProgress' ? 'InProgress' : 
                          status === 'resolved' ? 'Resolved' : status;
    
    return db.collection("complaints")
        .where("status", "==", formattedStatus)
        .orderBy("date", "desc")
        .onSnapshot((snapshot) => {
            const tableBody = document.querySelector('#complaintsTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.date.toDate();
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${data.studentName || 'N/A'}</td>
                    <td>${data.room || 'N/A'}</td>
                    <td>${data.category || 'N/A'}</td>
                    <td>${data.description || 'N/A'}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge ${getPriorityBadgeClass(data.priority)}">${data.priority || 'Medium'}</span></td>
                    <td><span class="badge ${getStatusBadgeClass(data.status)}">${data.status}</span></td>
                    <td>
                        ${data.status === 'Resolved' ? 
                            `<button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>` :
                            `<button class="btn-success" onclick="resolveComplaint('${doc.id}')">Resolve</button>
                             <button class="btn-warning" onclick="assignComplaint('${doc.id}')">Assign</button>
                             <button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>`
                        }
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (snapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No complaints found</td></tr>';
            }
        }, (error) => {
            console.error("Error listening to complaints:", error);
        });
}

// Function to resolve a complaint
async function resolveComplaint(complaintId) {
    if (confirm("Are you sure you want to mark this complaint as resolved?")) {
        try {
            await db.collection("complaints").doc(complaintId).update({
                status: "Resolved",
                resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Complaint marked as resolved successfully!");
        } catch (error) {
            console.error("Error resolving complaint:", error);
            alert("Error resolving complaint: " + error.message);
        }
    }
}

// Function to view complaint details
async function viewComplaintDetail(complaintId) {
    try {
        const doc = await db.collection("complaints").doc(complaintId).get();
        if (doc.exists) {
            const data = doc.data();
            const date = data.date.toDate();
            const formattedDate = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let details = `
                <div class="card">
                    <h2>Complaint Details</h2>
                    <p><strong>ID:</strong> ${complaintId}</p>
                    <p><strong>Student:</strong> ${data.studentName || 'N/A'}</p>
                    <p><strong>Room:</strong> ${data.room || 'N/A'}</p>
                    <p><strong>Category:</strong> ${data.category || 'N/A'}</p>
                    <p><strong>Priority:</strong> ${data.priority || 'Medium'}</p>
                    <p><strong>Status:</strong> ${data.status || 'Pending'}</p>
                    <p><strong>Date:</strong> ${formattedDate}</p>
                    <p><strong>Description:</strong></p>
                    <p>${data.description || 'No description provided'}</p>
            `;
            
            if (data.assignedTo) {
                details += `<p><strong>Assigned To:</strong> ${data.assignedTo}</p>`;
            }
            
            if (data.resolvedAt) {
                const resolvedDate = data.resolvedAt.toDate();
                const formattedResolvedDate = resolvedDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                details += `<p><strong>Resolved On:</strong> ${formattedResolvedDate}</p>`;
            }
            
            details += `</div>`;
            
            // Create a modal to display the details
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    ${details}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } else {
            alert("Complaint not found!");
        }
    } catch (error) {
        console.error("Error viewing complaint:", error);
        alert("Error loading complaint details");
    }
}
        function loadContent(page) {
            const content = document.getElementById('content');

            // Close mobile menu after selection
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }

            if (page === 'dashboard') {
                content.innerHTML = `
                <div class="card">
                    <h1>Admin Dashboard</h1>
                    <p>Welcome to the Hostel Management Admin System. Use the sidebar to navigate to different administrative features.</p>
                    <div class="stats-container">
                        <div class="stat-card" style="background-color: #e0e7ff;">
                            <h3 style="margin-top: 0; color: #1e3a8a;">Pending Registrations</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">5</p>
                        </div>
                        <div class="stat-card" style="background-color: #fee2e2;">
                            <h3 style="margin-top: 0; color: #1e3a8a;">Pending Complaints</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">7</p>
                        </div>
                        <div class="stat-card" style="background-color: #fef3c7;">
                            <h3 style="margin-top: 0; color: #1e3a8a;">Leave Requests</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">12</p>
                        </div>
                        <div class="stat-card" style="background-color: #dcfce7;">
                            <h3 style="margin-top: 0; color: #1e3a8a;">Outstanding Bills</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">15</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h1>Recent Activities</h1>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Activity</th>
                                    <th>Student</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>22 Mar, 10:30 AM</td>
                                    <td>New Registration</td>
                                    <td>John Smith</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td><button class="btn-success" onclick="viewDetail('reg123')">Review</button></td>
                                </tr>
                                <tr>
                                    <td>22 Mar, 09:45 AM</td>
                                    <td>Leave Application</td>
                                    <td>Sarah Johnson</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td><button class="btn-success" onclick="viewDetail('leave456')">Review</button></td>
                                </tr>
                                <tr>
                                    <td>22 Mar, 09:20 AM</td>
                                    <td>Complaint Filed</td>
                                    <td>Michael Brown</td>
                                    <td><span class="badge badge-red">Urgent</span></td>
                                    <td><button class="btn-success" onclick="viewDetail('comp789')">Review</button></td>
                                </tr>
                                <tr>
                                    <td>22 Mar, 08:50 AM</td>
                                    <td>Bill Payment</td>
                                    <td>Emily Wilson</td>
                                    <td><span class="badge badge-green">Completed</span></td>
                                    <td><button class="btn-secondary" onclick="viewDetail('pay234')">View</button></td>
                                </tr>
                                <tr>
                                    <td>21 Mar, 06:15 PM</td>
                                    <td>Attendance Updated</td>
                                    <td>Block B</td>
                                    <td><span class="badge badge-green">Completed</span></td>
                                    <td><button class="btn-secondary" onclick="viewDetail('att567')">View</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            } else if (page === 'registrations') {
    content.innerHTML = `
    <div class="card">
        <h1>Student Registrations</h1>
        <div class="filter-container">
            <div class="filter-item">
                <label for="regStatus">Status:</label>
                <select id="regStatus" class="form-input" style="width: auto; padding: 6px;">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="regBlock">Block:</label>
                <select id="regBlock" class="form-input" style="width: auto; padding: 6px;">
                    <option value="all">All</option>
                    <option value="blockA">Block A</option>
                    <option value="blockB">Block B</option>
                    <option value="blockC">Block C</option>
                </select>
            </div>
            <button class="btn" style="margin-top: 0;" onclick="loadRegistrations()">Apply Filters</button>
        </div>
        <div class="table-responsive">
            <table id="registrationsTable">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Email</th>
                        <th>Registration Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" style="text-align: center;">Loading registrations...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
            <button class="btn-secondary">Previous</button>
            <span>Page 1 of 1</span>
            <button class="btn">Next</button>
        </div>
    </div>
    <div class="card">
        <h1>Registration Summary</h1>
        <div class="stats-container">
            <div class="stat-card" style="background-color: #f3f4f6;">
                <h3 style="margin-top: 0;">Total Registrations</h3>
                <p id="totalRegistrations" style="font-size: 24px; font-weight: bold; margin: 10px 0;">0</p>
            </div>
            <div class="stat-card" style="background-color: #fef3c7;">
                <h3 style="margin-top: 0;">Pending</h3>
                <p id="pendingRegistrations" style="font-size: 24px; font-weight: bold; margin: 10px 0;">0</p>
            </div>
            <div class="stat-card" style="background-color: #dcfce7;">
                <h3 style="margin-top: 0;">Approved</h3>
                <p id="approvedRegistrations" style="font-size: 24px; font-weight: bold; margin: 10px 0;">0</p>
            </div>
            <div class="stat-card" style="background-color: #fee2e2;">
                <h3 style="margin-top: 0;">Rejected</h3>
                <p id="rejectedRegistrations" style="font-size: 24px; font-weight: bold; margin: 10px 0;">0</p>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn" onclick="downloadRegistrationReport()">Download Registration Report</button>
        </div>
    </div>`;
    
    // Load registrations when page loads
    loadRegistrations();

            } else if (page === 'leave') {
                content.innerHTML = `
                <div class="card">
                    <h1>Leave Applications</h1>
                    <div class="filter-container">
                        <div class="filter-item">
                            <label for="leaveStatus">Status:</label>
                            <select id="leaveStatus" class="form-input" style="width: auto; padding: 6px;">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="leaveDate">Date Range:</label>
                            <input type="date" id="leaveDate" class="form-input" style="width: auto; padding: 6px;">
                        </div>
                        <button class="btn" style="margin-top: 0;">Apply Filters</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Application ID</th>
                                    <th>Student Name</th>
                                    <th>From Date</th>
                                    <th>To Date</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>LEAVE2025045</td>
                                    <td>Sarah Johnson</td>
                                    <td>25 Mar, 2025</td>
                                    <td>28 Mar, 2025</td>
                                    <td>Family function</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td>
                                        <button class="btn-success" onclick="approveLeave('LEAVE2025045')">Approve</button>
                                        <button class="btn-danger" onclick="rejectLeave('LEAVE2025045')">Reject</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>LEAVE2025044</td>
                                    <td>Michael Brown</td>
                                    <td>24 Mar, 2025</td>
                                    <td>25 Mar, 2025</td>
                                    <td>Medical appointment</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td>
                                        <button class="btn-success" onclick="approveLeave('LEAVE2025044')">Approve</button>
                                        <button class="btn-danger" onclick="rejectLeave('LEAVE2025044')">Reject</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>LEAVE2025043</td>
                                    <td>Emily Wilson</td>
                                    <td>30 Mar, 2025</td>
                                    <td>2 Apr, 2025</td>
                                    <td>Conference attendance</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td>
                                        <button class="btn-success" onclick="approveLeave('LEAVE2025043')">Approve</button>
                                        <button class="btn-danger" onclick="rejectLeave('LEAVE2025043')">Reject</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>LEAVE2025042</td>
                                    <td>David Lee</td>
                                    <td>23 Mar, 2025</td>
                                    <td>23 Mar, 2025</td>
                                    <td>Interview</td>
                                    <td><span class="badge badge-green">Approved</span></td>
                                    <td>
                                        <button class="btn-secondary" onclick="viewLeaveDetails('LEAVE2025042')">View Details</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>LEAVE2025041</td>
                                    <td>Lisa Chen</td>
                                    <td>21 Mar, 2025</td>
                                    <td>22 Mar, 2025</td>
                                    <td>Personal emergency</td>
                                    <td><span class="badge badge-red">Rejected</span></td>
                                    <td>
                                        <button class="btn-secondary" onclick="viewLeaveDetails('LEAVE2025041')">View Details</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button class="btn-secondary">Previous</button>
                        <span>Page 1 of 4</span>
                        <button class="btn">Next</button>
                    </div>
                </div>
                <div class="card" id="leaveDetailCard" style="display:none;">
                    <h1>Leave Application Details</h1>
                    <div id="leaveDetailContent"></div>
                    <div class="form-action">
                        <button class="btn" onclick="closeLeaveDetail()">Close</button>
                    </div>
                </div>`;
            } else if (page === 'complaints') {
    content.innerHTML = `
    <div class="card">
        <h1>Complaints Management</h1>
        <div class="tab-container">
            <div class="tab active" onclick="switchComplaintTab('pending')">Pending</div>
            <div class="tab" onclick="switchComplaintTab('inProgress')">In Progress</div>
            <div class="tab" onclick="switchComplaintTab('resolved')">Resolved</div>
        </div>
        <div class="filter-container">
            <div class="filter-item">
                <label for="complaintCategory">Category:</label>
                <select id="complaintCategory" class="form-input" style="width: auto; padding: 6px;">
                    <option value="all">All</option>
                    <option value="electrical">Electrical</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="furniture">Furniture</option>
                    <option value="cleanliness">Cleanliness</option>
                    <option value="others">Others</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="complaintPriority">Priority:</label>
                <select id="complaintPriority" class="form-input" style="width: auto; padding: 6px;">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <button class="btn" style="margin-top: 0;" onclick="applyComplaintFilters()">Apply Filters</button>
        </div>
        <div class="table-responsive">
            <table id="complaintsTable">
                <thead>
                    <tr>
                        <th>Complaint ID</th>
                        <th>Student</th>
                        <th>Room</th>
                        <th>Category</th>
                        <th>Issue</th>
                        <th>Filed On</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="9" style="text-align: center;">Loading complaints...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>`;
    
    // Load complaints when page loads
    loadComplaints('pending');
    
            } else if (page === 'attendance') {
    content.innerHTML = `
    <div class="card">
        <h1>Attendance Management</h1>
        <div class="filter-container">
            <div class="filter-item">
                <label for="attendanceBlock">Block:</label>
                <select id="attendanceBlock" class="form-input" style="width: auto; padding: 6px;">
                    <option value="all">All Blocks</option>
                    <option value="blockA">Block A</option>
                    <option value="blockB">Block B</option>
                    <option value="blockC">Block C</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="attendanceDate">Date:</label>
                <input type="date" id="attendanceDate" class="form-input" style="width: auto; padding: 6px;" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <button class="btn" style="margin-top: 0;" onclick="loadAttendanceForDate()">View Attendance</button>
        </div>
        <div class="table-responsive">
            <table id="adminAttendanceTable">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Room</th>
                        <th>Morning (8 AM)</th>
                        <th>Evening (8 PM)</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" style="text-align: center;">Loading attendance data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h1>Take Attendance</h1>
        <form id="takeAttendanceForm">
            <div class="form-group">
                <label for="takeAttendanceBlock" class="form-label">Select Block:</label>
                <select id="takeAttendanceBlock" class="form-input" required>
                    <option value="">Select Block</option>
                    <option value="blockA">Block A</option>
                    <option value="blockB">Block B</option>
                    <option value="blockC">Block C</option>
                </select>
            </div>
            <div class="form-group">
                <label for="takeAttendanceTime" class="form-label">Attendance Time:</label>
                <select id="takeAttendanceTime" class="form-input" required>
                    <option value="">Select Time</option>
                    <option value="morning">Morning (8 AM)</option>
                    <option value="evening">Evening (8 PM)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="takeAttendanceStatus" class="form-label">Status:</label>
                <select id="takeAttendanceStatus" class="form-input" required>
                    <option value="">Select Status</option>
                    <option value="Present">Present</option>
                    <option value="Absent">Absent</option>
                    <option value="Late">Late</option>
                </select>
            </div>
            <div class="form-action">
                <button type="button" class="btn" onclick="submitAttendance()">Submit Attendance</button>
            </div>
        </form>
    </div>`;
            } else if (page === 'billing') {
                content.innerHTML = `
                <div class="card">
                    <h1>Billing Management</h1>
                    <div class="tab-container">
                        <div class="tab active" onclick="switchBillingTab('pending')">Pending (15)</div>
                        <div class="tab" onclick="switchBillingTab('paid')">Paid (132)</div>
                        <div class="tab" onclick="switchBillingTab('overdue')">Overdue (7)</div>
                    </div>
                    <div class="filter-container">
                        <div class="filter-item">
                            <label for="billingMonth">Month:</label>
                            <select id="billingMonth" class="form-input" style="width: auto; padding: 6px;">
                                <option value="mar2025">March 2025</option>
                                <option value="feb2025">February 2025</option>
                                <option value="jan2025">January 2025</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="billingBlock">Block:</label>
                            <select id="billingBlock" class="form-input" style="width: auto; padding: 6px;">
                                <option value="all">All Blocks</option>
                                <option value="blockA">Block A</option>
                                <option value="blockB">Block B</option>
                                <option value="blockC">Block C</option>
                            </select>
                        </div>
                        <button class="btn" style="margin-top: 0;">Apply Filters</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Invoice ID</th>
                                    <th>Student</th>
                                    <th>Room</th>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>INV2025089</td>
                                    <td>John Smith</td>
                                    <td>A-101</td>
                                    <td>March 2025</td>
                                    <td>$350.00</td>
                                    <td>31 Mar, 2025</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td>
                                        <button class="btn-warning" onclick="sendReminder('INV2025089')">Send Reminder</button>
                                        <button class="btn-secondary" onclick="viewInvoice('INV2025089')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>INV2025090</td>
                                    <td>Sarah Johnson</td>
                                    <td>B-205</td>
                                    <td>March 2025</td>
                                    <td>$325.00</td>
                                    <td>31 Mar, 2025</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td>
                                        <button class="btn-warning" onclick="sendReminder('INV2025090')">Send Reminder</button>
                                        <button class="btn-secondary" onclick="viewInvoice('INV2025090')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>INV2025091</td>
                                    <td>Michael Brown</td>
                                    <td>A-102</td>
                                    <td>March 2025</td>
                                    <td>$350.00</td>
                                    <td>31 Mar, 2025</td>
                                    <td><span class="badge badge-yellow">Pending</span></td>
                                    <td>
                                        <button class="btn-warning" onclick="sendReminder('INV2025091')">Send Reminder</button>
                                        <button class="btn-secondary" onclick="viewInvoice('INV2025091')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>INV2025055</td>
                                    <td>David Lee</td>
                                    <td>A-105</td>
                                    <td>February 2025</td>
                                    <td>$350.00</td>
                                    <td>29 Feb, 2025</td>
                                    <td><span class="badge badge-red">Overdue</span></td>
                                    <td>
                                        <button class="btn-danger" onclick="sendFinalReminder('INV2025055')">Final Notice</button>
                                        <button class="btn-secondary" onclick="viewInvoice('INV2025055')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>INV2025078</td>
                                    <td>Emily Wilson</td>
                                    <td>C-308</td>
                                    <td>March 2025</td>
                                    <td>$300.00</td>
                                    <td>31 Mar, 2025</td>
                                    <td><span class="badge badge-green">Paid</span></td>
                                    <td>
                                        <button class="btn-secondary" onclick="viewInvoice('INV2025078')">View</button>
                                        <button class="btn-secondary" onclick="downloadReceipt('INV2025078')">Receipt</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button class="btn-secondary">Previous</button>
                        <span>Page 1 of 3</span>
                        <button class="btn">Next</button>
                    </div>
                </div>
                <div class="card">
                    <h1>Generate Monthly Bills</h1>
                    <form>
                        <div class="form-group">
                            <label for="billGenMonth" class="form-label">Select Month:</label>
                            <select id="billGenMonth" class="form-input">
                                <option value="apr2025">April 2025</option>
                                <option value="mar2025">March 2025</option>
                                <option value="feb2025">February 2025</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="billGenBlock" class="form-label">Select Block:</label>
                            <select id="billGenBlock" class="form-input">
                                <option value="all">All Blocks</option>
                                <option value="blockA">Block A</option>
                                <option value="blockB">Block B</option>
                                <option value="blockC">Block C</option>
                            </select>
                        </div>
                        <div class="form-action">
                            <button type="button" class="btn">Generate Bills</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h1>Billing Summary</h1>
                    <div class="stats-container">
                        <div class="stat-card" style="background-color: #dcfce7;">
                            <h3 style="margin-top: 0;">Revenue (March)</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">$49,500</p>
                        </div>
                        <div class="stat-card" style="background-color: #fee2e2;">
                            <h3 style="margin-top: 0;">Outstanding</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">$7,350</p>
                        </div>
                        <div class="stat-card" style="background-color: #fef3c7;">
                            <h3 style="margin-top: 0;">Pending Bills</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">15</p>
                        </div>
                        <div class="stat-card" style="background-color: #f3f4f6;">
                            <h3 style="margin-top: 0;">Collection Rate</h3>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">87%</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn">Download Billing Report</button>
                    </div>
                </div>`;
            } else if (page === 'alerts') {
                content.innerHTML = `
                <div class="card">
                    <h1>Alerts & Notifications</h1>
                    <div class="filter-container">
                        <div class="filter-item">
                            <label for="alertType">Type:</label>
                            <select id="alertType" class="form-input" style="width: auto; padding: 6px;">
                                <option value="all">All</option>
                                <option value="system">System</option>
                                <option value="attendance">Attendance</option>
                                <option value="complaint">Complaint</option>
                                <option value="billing">Billing</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="alertPriority">Priority:</label>
                            <select id="alertPriority" class="form-input" style="width: auto; padding: 6px;">
                                <option value="all">All</option>
                                <option value="urgent">Urgent</option>
                                <option value="high">High</option>
                                <option value="normal">Normal</option>
                            </select>
                        </div>
                        <button class="btn" style="margin-top: 0;">Apply Filters</button>
                    </div>
                    <div class="alerts-container">
                        <div class="alert-item urgent">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>System Maintenance Notice</strong> <span class="badge badge-red">Urgent</span></span>
                                <span>22 Mar, 10:15 AM</span>
                            </div>
                            <p>The water supply will be shut down from 2 PM to 5 PM today for urgent maintenance. Please inform all residents.</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-warning" onclick="broadcastAlert('ALT001')">Broadcast</button>
                                <button class="btn-secondary" onclick="markAsRead('ALT001')">Mark as Read</button>
                            </div>
                        </div>
                        <div class="alert-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>New Complaint Registered</strong> <span class="badge badge-yellow">High</span></span>
                                <span>22 Mar, 9:45 AM</span>
                            </div>
                            <p>A new plumbing complaint (COMP2025078) has been registered by Michael Brown from room A-102. Bathroom sink leaking.</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-warning" onclick="viewComplaintDetail('COMP2025078')">View Complaint</button>
                                <button class="btn-secondary" onclick="markAsRead('ALT002')">Mark as Read</button>
                            </div>
                        </div>
                        <div class="alert-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>Attendance Alert</strong> <span class="badge badge-yellow">High</span></span>
                                <span>22 Mar, 9:30 AM</span>
                            </div>
                            <p>Student Michael Brown (STU2025003) from room A-102 has been absent for morning attendance without approved leave.</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-warning" onclick="contactStudent('STU2025003')">Contact Student</button>
                                <button class="btn-secondary" onclick="markAsRead('ALT003')">Mark as Read</button>
                            </div>
                        </div>
                        <div class="alert-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>Billing Reminder</strong> <span class="badge badge-blue">Normal</span></span>
                                <span>22 Mar, 8:00 AM</span>
                            </div>
                            <p>15 students have pending bills for March 2025 that are due on 31st March. Consider sending reminders.</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-warning" onclick="sendBulkReminder()">Send Reminders</button>
                                <button class="btn-secondary" onclick="markAsRead('ALT004')">Mark as Read</button>
                            </div>
                        </div>
                        <div class="alert-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>New Registration</strong> <span class="badge badge-blue">Normal</span></span>
                                <span>21 Mar, 5:30 PM</span>
                            </div>
                            <p>A new registration application (REG2025001) has been submitted by John Smith. The application is pending review.</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-warning" onclick="viewRegistrationDetails('REG2025001')">View Application</button>
                                <button class="btn-secondary" onclick="markAsRead('ALT005')">Mark as Read</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h1>Send Notification</h1>
                    <form>
                        <div class="form-group">
                            <label for="notificationType" class="form-label">Notification Type:</label>
                            <select id="notificationType" class="form-input">
                                <option value="announcement">General Announcement</option>
                                <option value="emergency">Emergency Alert</option>
                                <option value="reminder">Payment Reminder</option>
                                <option value="event">Event Notification</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notificationRecipients" class="form-label">Recipients:</label>
                            <select id="notificationRecipients" class="form-input">
                                <option value="all">All Students</option>
                                <option value="blockA">Block A</option>
                                <option value="blockB">Block B</option>
                                <option value="blockC">Block C</option>
                                <option value="specific">Specific Students</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notificationTitle" class="form-label">Title:</label>
                            <input type="text" id="notificationTitle" class="form-input" placeholder="Enter notification title">
                        </div>
                        <div class="form-group">
                            <label for="notificationMessage" class="form-label">Message:</label>
                            <textarea id="notificationMessage" class="form-input" rows="4" placeholder="Enter your message here"></textarea>
                        </div>
                        <div class="form-action">
                            <button type="button" class="btn">Send Notification</button>
                        </div>
                    </form>
                </div>`;
            }
        }

        // Function to toggle the sidebar menu on mobile
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Function to switch between complaint tabs
        function switchComplaintTab(tab) {
    const tabs = document.querySelectorAll('.tab-container .tab');
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab-container .tab[onclick="switchComplaintTab('${tab}')"]`).classList.add('active');
    
    // Load complaints for the selected tab
    loadComplaints(tab);
}
        // Function to switch between billing tabs
        function switchBillingTab(tab) {
            const tabs = document.querySelectorAll('.tab-container .tab');
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab-container .tab[onclick="switchBillingTab('${tab}')"]`).classList.add('active');
            // Load content based on the selected tab
            loadContent('billing');
        }

        // Function to view leave application details
        function viewLeaveDetails(leaveId) {
            const leaveDetailCard = document.getElementById('leaveDetailCard');
            const leaveDetailContent = document.getElementById('leaveDetailContent');
            leaveDetailContent.innerHTML = `
                    <p><strong>Application ID:</strong> ${leaveId}</p>
                <p><strong>Student Name:</strong> John Smith</p>
                <p><strong>From Date:</strong> 25 Mar, 2025</p>
                <p><strong>To Date:</strong> 28 Mar, 2025</p>
                <p><strong>Reason:</strong> Family function</p>
                <p><strong>Status:</strong> Pending</p>`;
            leaveDetailCard.style.display = 'block';
        }

        // Function to close leave application details
        function closeLeaveDetail() {
            document.getElementById('leaveDetailCard').style.display = 'none';
        }

        // Function to view complaint details
        function viewComplaintDetail(complaintId) {
            alert(`Viewing details for complaint: ${complaintId}`);
        }

        // Function to view registration details
        function viewRegistrationDetails(regId) {
            alert(`Viewing details for registration: ${regId}`);
        }

        // Function to view invoice details
        function viewInvoice(invoiceId) {
            alert(`Viewing details for invoice: ${invoiceId}`);
        }

        // Function to view attendance history
        function viewAttendanceHistory(studentId) {
            alert(`Viewing attendance history for student: ${studentId}`);
        }

        // Function to send an alert to a student
        function sendAlert(studentId) {
            alert(`Sending alert to student: ${studentId}`);
        }

        // Function to send a reminder for an invoice
        function sendReminder(invoiceId) {
            alert(`Sending reminder for invoice: ${invoiceId}`);
        }

        // Function to send a final reminder for an overdue invoice
        function sendFinalReminder(invoiceId) {
            alert(`Sending final reminder for invoice: ${invoiceId}`);
        }

        // Function to download a receipt for an invoice
        function downloadReceipt(invoiceId) {
            alert(`Downloading receipt for invoice: ${invoiceId}`);
        }

        // Function to broadcast an alert
        function broadcastAlert(alertId) {
            alert(`Broadcasting alert: ${alertId}`);
        }

        // Function to mark an alert as read
        function markAsRead(alertId) {
            alert(`Marking alert as read: ${alertId}`);
        }

        // Function to contact a student
        function contactStudent(studentId) {
            alert(`Contacting student: ${studentId}`);
        }

        // Function to send bulk reminders for pending bills
        function sendBulkReminder() {
            alert('Sending bulk reminders for pending bills');
        }
    // Function to load complaints based on status
async function loadComplaints(status) {
    try {
        const tableBody = document.querySelector('#complaintsTable tbody');
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Loading complaints...</td></tr>';
        
        const querySnapshot = await db.collection("complaints")
            .where("status", "==", status)
            .orderBy("date", "desc")
            .get();
        
        if (querySnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No complaints found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        
        querySnapshot.forEach(doc => {
            const data = doc.data();
            const date = data.date.toDate();
            const formattedDate = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${doc.id}</td>
                <td>${data.studentName || 'N/A'}</td>
                <td>${data.room || 'N/A'}</td>
                <td>${data.category || 'N/A'}</td>
                <td>${data.description || 'N/A'}</td>
                <td>${formattedDate}</td>
                <td><span class="badge ${getPriorityBadgeClass(data.priority)}">${data.priority || 'Medium'}</span></td>
                <td><span class="badge ${getStatusBadgeClass(data.status)}">${data.status}</span></td>
                <td>
                    <button class="btn-warning" onclick="assignComplaint('${doc.id}')">Assign</button>
                    <button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Set up real-time listener
        setupComplaintsListener(status);
    } catch (error) {
        console.error("Error loading complaints:", error);
        const tableBody = document.querySelector('#complaintsTable tbody');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Error loading complaints</td></tr>';
        }
    }
}

// Helper function for priority badge styling
function getPriorityBadgeClass(priority) {
    switch (priority.toLowerCase()) {
        case 'high': return 'badge-red';
        case 'medium': return 'badge-yellow';
        case 'low': return 'badge-blue';
        default: return 'badge-blue';
    }
}

// Helper function for status badge styling
function getStatusBadgeClass(status) {
    switch (status.toLowerCase()) {
        case 'pending': return 'badge-yellow';
        case 'inprogress': return 'badge-blue';
        case 'resolved': return 'badge-green';
        default: return 'badge-blue';
    }
}
async function applyComplaintFilters() {
    const category = document.getElementById('complaintCategory').value;
    const priority = document.getElementById('complaintPriority').value;
    const activeTab = document.querySelector('.tab-container .tab.active');
    const status = activeTab ? activeTab.getAttribute('onclick').match(/'([^']+)'/)[1] : 'pending';
    
    try {
        const tableBody = document.querySelector('#complaintsTable tbody');
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Loading complaints...</td></tr>';
        
        let query = db.collection("complaints");
        
        // Always filter by status
        const formattedStatus = status === 'pending' ? 'Pending' : 
                              status === 'inProgress' ? 'InProgress' : 
                              status === 'resolved' ? 'Resolved' : status;
        query = query.where("status", "==", formattedStatus);
        
        // Apply category filter if not 'all'
        if (category !== 'all') {
            query = query.where("category", "==", category);
        }
        
        // Apply priority filter if not 'all'
        if (priority !== 'all') {
            query = query.where("priority", "==", priority);
        }
        
        // Order by date
        query = query.orderBy("date", "desc");
        
        const querySnapshot = await query.get();
        
        if (querySnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No complaints match the filters</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        
        querySnapshot.forEach(doc => {
            const data = doc.data();
            const date = data.date.toDate();
            const formattedDate = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${doc.id}</td>
                <td>${data.studentName || 'N/A'}</td>
                <td>${data.room || 'N/A'}</td>
                <td>${data.category || 'N/A'}</td>
                <td>${data.description || 'N/A'}</td>
                <td>${formattedDate}</td>
                <td><span class="badge ${getPriorityBadgeClass(data.priority)}">${data.priority || 'Medium'}</span></td>
                <td><span class="badge ${getStatusBadgeClass(data.status)}">${data.status}</span></td>
                <td>
                    ${data.status === 'Resolved' ? 
                        `<button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>` :
                        `<button class="btn-success" onclick="resolveComplaint('${doc.id}')">Resolve</button>
                         <button class="btn-warning" onclick="assignComplaint('${doc.id}')">Assign</button>
                         <button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>`
                    }
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    } catch (error) {
        console.error("Error filtering complaints:", error);
        const tableBody = document.querySelector('#complaintsTable tbody');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">Error filtering complaints</td></tr>';
        }
    }
}
function getStatusCircleClass(status) {
    if (status === "Present") return "circle-green";
    if (status === "Absent") return "circle-red";
    if (status === "Late") return "circle-yellow";
    return "";
}

function getOverallStatus(data) {
    if (!data.morningStatus && !data.eveningStatus) return "Not recorded";
    if (data.morningStatus === "Absent" || data.eveningStatus === "Absent") return "Irregular";
    if (data.morningStatus === "Late" || data.eveningStatus === "Late") return "Late";
    return "Regular";
}

function getStatusBadgeClass(data) {
    const status = getOverallStatus(data);
    if (status === "Regular") return "badge-green";
    if (status === "Irregular") return "badge-red";
    if (status === "Late") return "badge-yellow";
    return "badge-blue";
}

async function submitAttendance() {
    const block = document.getElementById('takeAttendanceBlock').value;
    const time = document.getElementById('takeAttendanceTime').value;
    const status = document.getElementById('takeAttendanceStatus').value;
    
    if (!block || !time || !status) {
        alert("Please fill all fields");
        return;
    }
    
    const studentId = prompt("Enter Student ID:");
    const studentName = prompt("Enter Student Name:");
    const room = prompt("Enter Room Number:");
    
    if (!studentId || !studentName) {
        alert("Student information is required");
        return;
    }
    
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Normalize to start of day
        const docId = `${studentId}_${today.toISOString().split('T')[0]}`;
        
        const attendanceData = {
            studentId,
            studentName,
            room,
            block,
            date: firebase.firestore.Timestamp.fromDate(today),
            [time === 'morning' ? 'morningStatus' : 'eveningStatus']: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Merge with existing data if any
        await db.collection("attendance").doc(docId).set(attendanceData, { merge: true });
        
        alert("Attendance recorded successfully!");
        document.getElementById('takeAttendanceForm').reset();
        loadAttendanceForDate(); // Refresh the view
    } catch (error) {
        console.error("Error submitting attendance:", error);
        alert("Error recording attendance: " + error.message);
    }
}
function editAttendance(docId) {
    // Implement edit functionality
    alert(`Editing attendance record: ${docId}`);
}
const functions = require('firebase-functions');
const admin = require('./admin');

exports.addAdminRole = functions.https.onCall(async (data, context) => {
  // Check if request is made by an existing admin
  if (context.auth.token.admin !== true) {
    return { error: 'Only admins can add other admins' };
  }

  // Get user and add custom claim
  try {
    const user = await admin.auth().getUserByEmail(data.email);
    await admin.auth().setCustomUserClaims(user.uid, {
      admin: true
    });
    
    return { message: `Success! ${data.email} has been made an admin` };
  } catch (error) {
    return { error: error.message };
  }
});
async function checkAdminStatus() {
  try {
    const user = firebase.auth().currentUser;
    if (!user) return false;
    
    // Force token refresh to get the latest claims
    await user.getIdToken(true);
    const decodedToken = await user.getIdTokenResult();
    return decodedToken.claims.admin === true;
  } catch (error) {
    console.error("Error checking admin status:", error);
    return false;
  }
}
loadAttendanceForDate();

firebase.auth().onAuthStateChanged(async (user) => {
  if (user) {
    // Check if user is admin
    const isAdmin = await checkAdminStatus();
    
    if (isAdmin) {
      // Redirect to admin dashboard
      window.location.href = "adminnn.html";
    } else {
      // Redirect to student dashboard
      window.location.href = "newwww.html";
    }
  } else {
    // User is signed out
    window.location.href = "login.html";
  }
});
// Add these functions to the script section
let attendanceListener = null;

async function loadAttendanceForDate() {
    const dateInput = document.getElementById('attendanceDate').value;
    const block = document.getElementById('attendanceBlock').value;
    
    // Remove previous listener if exists
    if (attendanceListener) {
        attendanceListener();
    }
    
    try {
        const date = new Date(dateInput);
        date.setHours(0, 0, 0, 0);
        
        // Set up real-time listener
        attendanceListener = setupAttendanceListener(dateInput, block);
        
    } catch (error) {
        console.error("Error loading attendance:", error);
        alert("Error loading attendance data: " + error.message);
    }
}
async function editAttendance(docId) {
    try {
        const doc = await db.collection("attendance").doc(docId).get();
        if (!doc.exists) {
            alert("Attendance record not found!");
            return;
        }
        
        const data = doc.data();
        const newStatus = prompt(`Edit attendance for ${data.studentName} (Current: ${data.morningStatus || 'Not recorded'}/${data.eveningStatus || 'Not recorded'})\n\nEnter new status (Present/Absent/Late):`);
        
        if (newStatus && ["Present", "Absent", "Late"].includes(newStatus)) {
            const time = prompt("Which session? (morning/evening):");
            if (time && ["morning", "evening"].includes(time)) {
                await db.collection("attendance").doc(docId).update({
                    [`${time}Status`]: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Attendance updated successfully!");
            }
        }
    } catch (error) {
        console.error("Error editing attendance:", error);
        alert("Error updating attendance: " + error.message);
    }
}
function setupAttendanceListener(date, block) {
    const normalizedDate = new Date(date);
    normalizedDate.setHours(0, 0, 0, 0);
    
    let query = db.collection("attendance")
        .where("date", "==", firebase.firestore.Timestamp.fromDate(normalizedDate));
    
    if (block !== "all") {
        query = query.where("block", "==", block);
    }
    
    return query.onSnapshot((snapshot) => {
        const tableBody = document.querySelector('#adminAttendanceTable tbody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        if (snapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No attendance records found</td></tr>';
            return;
        }
        
        snapshot.forEach(doc => {
            const data = doc.data();
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${data.studentId}</td>
                <td>${data.studentName}</td>
                <td>${data.room || 'N/A'}</td>
                <td>
                    <span class="circle ${getStatusCircleClass(data.morningStatus)}"></span> 
                    ${data.morningStatus || 'Not recorded'}
                </td>
                <td>
                    <span class="circle ${getStatusCircleClass(data.eveningStatus)}"></span> 
                    ${data.eveningStatus || 'Not recorded'}
                </td>
                <td><span class="badge ${getStatusBadgeClass(data)}">${getOverallStatus(data)}</span></td>
                <td>
                    <button class="btn-secondary" onclick="editAttendance('${doc.id}')">Edit</button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }, (error) => {
        console.error("Error listening to attendance:", error);
    });
}

// Real-time listener for complaints
function setupComplaintsListener(status) {
    return db.collection("complaints")
        .where("status", "==", status)
        .orderBy("date", "desc")
        .onSnapshot((snapshot) => {
            const tableBody = document.querySelector('#complaintsTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.date.toDate();
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${data.studentName || 'N/A'}</td>
                    <td>${data.room || 'N/A'}</td>
                    <td>${data.category || 'N/A'}</td>
                    <td>${data.description || 'N/A'}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge ${getPriorityBadgeClass(data.priority)}">${data.priority || 'Medium'}</span></td>
                    <td><span class="badge ${getStatusBadgeClass(data.status)}">${data.status}</span></td>
                    <td>
                        <button class="btn-warning" onclick="assignComplaint('${doc.id}')">Assign</button>
                        <button class="btn-secondary" onclick="viewComplaintDetail('${doc.id}')">View</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (snapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No complaints found</td></tr>';
            }
        }, (error) => {
            console.error("Error listening to complaints:", error);
        });
}

// Update the switchComplaintTab function
function switchComplaintTab(tab) {
    const tabs = document.querySelectorAll('.tab-container .tab');
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab-container .tab[onclick="switchComplaintTab('${tab}')"]`).classList.add('active');
    
    // Convert tab to proper status
    let status;
    switch(tab) {
        case 'pending': status = 'Pending'; break;
        case 'inProgress': status = 'InProgress'; break;
        case 'resolved': status = 'Resolved'; break;
        default: status = 'Pending';
    }
    
    loadComplaints(status);
}
// Registration management functions
let registrationsListener = null;

async function loadRegistrations() {
    const status = document.getElementById('regStatus').value;
    const block = document.getElementById('regBlock').value;
    
    // Remove previous listener if exists
    if (registrationsListener) {
        registrationsListener();
    }
    
    try {
        const tableBody = document.querySelector('#registrationsTable tbody');
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Loading registrations...</td></tr>';
        
        let query = db.collection("users");
        
        // Apply status filter if not 'all'
        if (status !== 'all') {
            query = query.where("status", "==", status);
        }
        
        // Apply block filter if not 'all'
        if (block !== 'all') {
            query = query.where("block", "==", block);
        }
        
        // Order by registration date
        query = query.orderBy("createdAt", "desc");
        
        // Set up real-time listener
        registrationsListener = query.onSnapshot((snapshot) => {
            updateRegistrationsTable(snapshot);
            updateRegistrationStats(snapshot);
        }, (error) => {
            console.error("Error loading registrations:", error);
            const tableBody = document.querySelector('#registrationsTable tbody');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading registrations</td></tr>';
            }
        });
    } catch (error) {
        console.error("Error loading registrations:", error);
        alert("Error loading registration data: " + error.message);
    }
}

function updateRegistrationsTable(snapshot) {
    const tableBody = document.querySelector('#registrationsTable tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (snapshot.empty) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No registrations found</td></tr>';
        return;
    }
    
    snapshot.forEach(doc => {
        const data = doc.data();
        const date = data.createdAt.toDate();
        const formattedDate = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${data.uid || 'N/A'}</td>
            <td>${data.email || 'N/A'}</td>
            <td>${formattedDate}</td>
            <td><span class="badge ${getRegistrationStatusBadgeClass(data.status || 'pending')}">${data.status || 'Pending'}</span></td>
            <td>
                ${data.status === 'approved' ? 
                    `<button class="btn-secondary" onclick="viewRegistrationDetails('${doc.id}')">View</button>` :
                    `<button class="btn-success" onclick="approveRegistration('${doc.id}')">Approve</button>
                    <button class="btn-danger" onclick="rejectRegistration('${doc.id}')">Reject</button>`
                }
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function updateRegistrationStats(snapshot) {
    let total = 0;
    let pending = 0;
    let approved = 0;
    let rejected = 0;
    
    snapshot.forEach(doc => {
        const data = doc.data();
        total++;
        switch(data.status) {
            case 'pending': pending++; break;
            case 'approved': approved++; break;
            case 'rejected': rejected++; break;
            default: pending++;
        }
    });
    
    document.getElementById('totalRegistrations').textContent = total;
    document.getElementById('pendingRegistrations').textContent = pending;
    document.getElementById('approvedRegistrations').textContent = approved;
    document.getElementById('rejectedRegistrations').textContent = rejected;
}

function getRegistrationStatusBadgeClass(status) {
    switch (status.toLowerCase()) {
        case 'pending': return 'badge-yellow';
        case 'approved': return 'badge-green';
        case 'rejected': return 'badge-red';
        default: return 'badge-yellow';
    }
}

async function approveRegistration(userId) {
    try {
        // Find the document ID for this user
        const querySnapshot = await db.collection("users").where("uid", "==", userId).get();
        if (querySnapshot.empty) {
            alert("User not found!");
            return;
        }
        
        // Update all matching documents (should be just one)
        const batch = db.batch();
        querySnapshot.forEach(doc => {
            const docRef = db.collection("users").doc(doc.id);
            batch.update(docRef, {
                status: "approved",
                approvedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        await batch.commit();
        alert("Registration approved successfully!");
    } catch (error) {
        console.error("Error approving registration:", error);
        alert("Error approving registration: " + error.message);
    }
}

async function rejectRegistration(userId) {
    if (confirm("Are you sure you want to reject this registration?")) {
        try {
            // Find the document ID for this user
            const querySnapshot = await db.collection("users").where("uid", "==", userId).get();
            if (querySnapshot.empty) {
                alert("User not found!");
                return;
            }
            
            // Update all matching documents (should be just one)
            const batch = db.batch();
            querySnapshot.forEach(doc => {
                const docRef = db.collection("users").doc(doc.id);
                batch.update(docRef, {
                    status: "rejected",
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
            alert("Registration rejected successfully!");
        } catch (error) {
            console.error("Error rejecting registration:", error);
            alert("Error rejecting registration: " + error.message);
        }
    }
}

async function viewRegistrationDetails(userId) {
    try {
        const querySnapshot = await db.collection("users").where("uid", "==", userId).get();
        if (querySnapshot.empty) {
            alert("User not found!");
            return;
        }
        
        const doc = querySnapshot.docs[0];
        const data = doc.data();
        const createdAt = data.createdAt.toDate();
        const formattedDate = createdAt.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let details = `
            <p><strong>Student ID:</strong> ${data.uid || 'N/A'}</p>
            <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
            <p><strong>Registration Date:</strong> ${formattedDate}</p>
            <p><strong>Status:</strong> ${data.status || 'Pending'}</p>
        `;
        
        if (data.approvedAt) {
            const approvedDate = data.approvedAt.toDate();
            const formattedApprovedDate = approvedDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            details += `<p><strong>Approved On:</strong> ${formattedApprovedDate}</p>`;
        }
        
        if (data.rejectedAt) {
            const rejectedDate = data.rejectedAt.toDate();
            const formattedRejectedDate = rejectedDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            details += `<p><strong>Rejected On:</strong> ${formattedRejectedDate}</p>`;
        }
        
        // Add any additional user details here
        if (data.fullName) details += `<p><strong>Full Name:</strong> ${data.fullName}</p>`;
        if (data.phone) details += `<p><strong>Phone:</strong> ${data.phone}</p>`;
        if (data.room) details += `<p><strong>Room:</strong> ${data.room}</p>`;
        if (data.block) details += `<p><strong>Block:</strong> ${data.block}</p>`;
        
        alert(`Registration Details:\n\n${details}`);
    } catch (error) {
        console.error("Error viewing registration:", error);
        alert("Error loading registration details");
    }
}

function downloadRegistrationReport() {
    alert("This would generate and download a registration report in a real implementation");
}
// Function to view complaint details
async function viewComplaintDetail(complaintId) {
    try {
        const doc = await db.collection("complaints").doc(complaintId).get();
        if (doc.exists) {
            const data = doc.data();
            const date = data.date.toDate();
            const formattedDate = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            alert(`Complaint Details:\n\n
                  ID: ${complaintId}\n
                  Student: ${data.studentName}\n
                  Room: ${data.room}\n
                  Category: ${data.category}\n
                  Priority: ${data.priority}\n
                  Status: ${data.status}\n
                  Date: ${formattedDate}\n
                  Description: ${data.description}\n
                  ${data.assignedTo ? `Assigned To: ${data.assignedTo}` : ''}`);
        } else {
            alert("Complaint not found!");
        }
    } catch (error) {
        console.error("Error viewing complaint:", error);
        alert("Error loading complaint details");
    }
}

// Function to assign a complaint
async function assignComplaint(complaintId) {
    const assignee = prompt("Enter staff name to assign this complaint to:");
    if (assignee) {
        try {
            await db.collection("complaints").doc(complaintId).update({
                status: "InProgress",
                assignedTo: assignee,
                assignedDate: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Complaint assigned successfully!");
        } catch (error) {
            console.error("Error assigning complaint:", error);
            alert("Error assigning complaint");
        }
    }
}
    </script>
</body>

</html>